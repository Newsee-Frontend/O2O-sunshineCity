<template>
  <div class="ns-grids">
    <!--grid-->
    <ns-base-grid
      :gridID="gridID"
      :loadState="loadState"
      :keyRefer="keyRefer"
      :gridHead="gridHead"
      :gridData="gridData"
      :searchConditions="searchConditions"
      :sizeInfo="sizeInfo"
      :initDynamicSize="initDynamicSize"
      :autoResize="autoResize"
      :holderInfo="holderInfo"
      :firstColType="firstColType"
      :handleColType="handleColType"
      :ationColConfig="ationColConfig"
      :showHeadOperation="showHeadOperation"
      :showAddRowOperation="showAddRowOperation"
      :showPanel="showPanel"
      :align="align"
      :border="border"
      :resizable="resizable"
      :hideSummaryForced="hideSummaryForced"
      :sumDataCustom="sumDataCustom"
      :sumDataSource="sumDataSource"
      :sumFixedNum="sumFixedNum"
      :pageSizes="pageSizes"
      :layout="layout"
      :pagerCount="pagerCount"
      :gridCheck="gridCheck"
      :topGapForErrMsg="topGapForErrMsg"
      @refreshGrid="refreshGrid"
      @cell-action="cellAction"
      @grid-ation="gridAtion"
      @selection-change="selectionChange"
      @setting-submit="settingSubmit"
      @add-row="addRow"
      @delete-current-row="deleteCurrentRow"
    >
    </ns-base-grid>
  </div>
</template>
<script>
  import {listColumnService} from '../../../service/TableFetch/table-fetch';
  import ns from '../../../utils/nsQuery/nsQuery';
  import keyRefer from './keyRefer';
  import {mapGetters} from 'vuex';

  export default {
    name: 'ns-grids',
    data() {
      return {
        //============= basic data =============
        btnType: {},
        dialogTit: null,
        scope: {}, //grid scope
        gridSelectList: [],
        //============= grid modeules =============
        keyRefer: keyRefer,
        headRefer: keyRefer.head,
        gridHead: [], //表头数据
      };
    },
    props: {
      //============== 表格部分 =================

      //----- 基础 -----
      loadState: {
        type: Object,
        default: {
          data: false,
          head: false,
        },
      }, //表格数据加载状态
      gridID: {type: String}, //表唯一ID值
      searchConditions: {
        type: Object,
        default() {
          return {};
        },
      },
      //----- 表头，表数据获取 -----
      gridData: {
        type: Object,
        default() {
          return {};
        },
      }, //列表数据
      headSource: {type: String, default: 'request'}, //表头数据来源
      LocalHead: {type: Array}, //本地表头数据
      mockQuery: {
        type: Object,
        default: function () {
          return {
            page: 'normal',
            type: 'normal',
          };
        },
      }, //mockdata query
      thlist: {
        type: Object,
        default() {
          return {
            thlistDefault: [],
          };
        },
      }, //表头数据 - 筛选器需要
      //============== 分页器部分 =================

      //----- 表格展现形式 -----
      align: {type: String}, //内容位置（居中，左、右)
      border: {type: Boolean, default: true}, //表格是否有边框
      resizable: {type: Boolean, default: true}, //对应列是否可以通过拖动改变宽度（需要在 el-table 上设置 border 属性为真）
      firstColType: {type: String}, //第一列固定列类型（非自动表头配置）index selection radio=>没有则为null
      handleColType: {type: String}, //固定操作列类型（非自动表头配置） handle =>没有则为null
      ationColConfig: {type: Object}, //固定操作列自定义配置
      showPanel: {type: Boolean, default: true}, //分页器显示开关
      showHeadOperation: {type: Boolean, default: true}, //表头设置操作模块开关
      showAddRowOperation: {type: Boolean, default: false}, //表头设置 新增行操作模块开关

      //----- 列表高度尺寸 -----
      sizeInfo: {
        type: Object,
        default: function () {
          return {
            maxHeight: 500, //表格渲染高度默认值
          };
        },
      }, //尺寸信息
      initDynamicSize: {type: Boolean, default: true}, //是否为动态尺寸 （初始化渲染动态）
      autoResize: {type: Boolean, default: true}, //表格高度是否自适应窗口变化
      holderInfo: {
        type: Object,
        default() {
          return {
            fatherID: 'ns-container-right',
            childIDList: ['search', 'panel-page'],
          };
        },
      }, //表格容器信息（包含父级容器和所包含的子级容器列表)

      //----- 合计行 -----
      hideSummaryForced: {type: Boolean, default: false}, //是否强制隐藏合计行模块，默认为不隐藏
      sumDataCustom: {type: Object, default: null}, //全部数据合计行数据自定义（外部传入）
      sumDataSource: {type: String, default: 'list'}, //全部数据合计行数据来源 (list / sumtotal )
      sumFixedNum: {type: Number, default: 2}, //当前页合计 数字 保留几位小数

      //============== 分页器部分 =================
      layout: {type: String, default: 'total, sizes, prev, pager, next, jumper'}, //分页器组件组件布局，子组件名用逗号分隔
      pageSizes: {type: Array}, //每页显示个数选择器的选项设置
      pagerCount: {type: Number}, //页码按钮的数量，当总页数超过该值时会折叠

      //============== 验证 =================
      gridCheck: {type: Object}, //grid check data for form in grid cell
      topGapForErrMsg: {type: Number}, //表格第一行顶部留白间距（为验证错误信息腾出空间)

      //============== 单元格点击 footer-switch =================
      isFooterButton: {type: String},
      funcId: {
        type: [Number, String],
      },
    },
    computed: {
      ...mapGetters(['roleButtonList']),

      //表格的权限按钮
      roleBtns: function(){
        return this.roleButtonList.filter((item) => {
          return (item.areaType === "GRID")&&(item.btnType === "single")
        });
      }
    },

    watch: {
      gridData(val){
       if(val.list.length > 0){
         this.getRoleButtonList()
       }
      }
    },

    created() {
      //table header data fetch（ 获取表头数据请求 ）
      this.headerFetch();
      this.getRoleButtonList()
    },
    mounted() {

    },
    methods: {
      /**
       * table header data fetch（ 获取表头数据请求 ）
       */
      headerFetch() {
        this.loadState.head = false;
        if (this.headSource === 'request') {
          //grid head init request
          listColumnService({funcId: this.funcId})
            .then(res => {
              const list = res.resultData.columns;
              console.log('获取服务端表头数据！！！');
              console.log(list);
              this.thlist.thlistDefault = list; //为筛选器需要的表头数据赋值
              this.searchConditions.header = list;
              //grid head data handle
              this.gridHead = this.headerHandle('tofront', list);
              console.log('处理后的服务端表头数据！！！');
              console.log(this.gridHead);
              this.loadState.head = true;
            })
            .catch(r => {
              this.$message({message: '系统错误', type: 'error'});
              this.loadState.head = true;
            });
        } else if (this.headSource === 'Local') {
          console.log('获取本地表头数据！！！');
          if (!Array.isArray(this.LocalHead) || this.LocalHead.length < 1) {
            throw 'LocalHead data must be Array format, and the length of the Array must be more than 0, find it.';
          }
          this.thlist.thlistDefault = this.LocalHead; //为筛选器需要的表头数据赋值
          this.gridHead = this.headerHandle('tofront', this.LocalHead); //表头数据处理，并赋值
          console.log(this.gridHead);
          this.loadState.head = true;
        } else {
          throw 'Please set up the correct header data source ( by " headSource "  -  "request" or "Local" ).';
        }
      },

      /**
       * headerHandle （ 表格表头数据处理）
       * @param type
       * @param head
       */
      headerHandle(type, head) {
        //backend data => Front data
        if (type === 'tofront') {
          return head.map(item => {
            const hidden = this.headRefer['hidden'];
            const fixedKey = this.headRefer['fixed'];
            //cover hidden property value
            item[hidden] = this.showStateCover(type, item[hidden]);
            if (!item.hasOwnProperty(fixedKey)) {
              item[fixedKey] = false;
            }
            return item;
          });
        }
        //Front data => backend data
        else {
          return head.map(item => {
            const key = this.headRefer['hidden'];
            item[key] = this.showStateCover('toback', item[key]);
            return item;
          });
        }
      },

      /**
       * showStateCover （ 表格表头显隐值转换 ）
       * @param type
       * @param val
       */
      showStateCover(type, val) {
        if (type === 'tofront') {
          if (ns.base.judgeType(val) === 'boolean') {
            return val;
          }
          return val !== '0';
        } else if (type === 'toback') {
          return val ? '1' : '0';
        } else {
          return val;
        }
      },

      /**
       * cell-action （ 表格单元格点击行为事件 ）
       * @param scope     grid data in current row
       * @param item      grid head item data in current col
       */
      cellAction(scope, item) {
        this.$emit('cellAction', scope, item)
      },

      //刷新表事件抛出回调
      refreshGrid() {
        this.$emit('refreshGrid');
      },

      /**
       * grid ation event （操作列操作回调事件）
       * @param info
       * @param scope
       */
      gridAtion(info, scope) {
        this.$emit('grid-ation', info, scope);
      },

      /**
       * selection change （表数据 checkbox 选择的时候）
       * @param selection
       */
      selectionChange(selection) {
        this.$emit('selection-change', selection);
      },

      /**
       * setting head list submit （表头操作设置提交抛出回调）
       * @param query
       */
      settingSubmit(query) {
        console.log('表头操作设置提交抛出回调');
        this.gridHead = JSON.parse(JSON.stringify(query)); //刷新表头数据
        const requestData = this.headerHandle('toback', query); //处理好的返回给后台的表头数据
        console.log('提交给后台的表头数据');
        console.log(requestData);
        this.loadState.head = true;
        //refresh grid（ 刷新表事件抛出回调 ）
        this.$emit('refreshGrid');
      },

      /**
       * delete current row
       * @param index
       * @param row
       * @param gridData
       */
      deleteCurrentRow(index, row, gridData) {
        this.$emit('delete-current-row', index, row, gridData);
      },

      /**
       * add row to grid
       * @param gridData
       */
      addRow(gridData) {
        this.$emit('add-row', gridData);
      },

      //权限按钮
      getRoleButtonList(){
        // this.gridObj = JSON.parse(JSON.stringify(this.gridData));
        if(this.roleBtns && this.gridData.list){
          //根据权限显示表格操作列按钮
          this.gridData.list.map((item,key)=>{
            if(item.fnsclick){
              let fnsclick = [];
              item.fnsclick.map( (o,index) => {
                let obj = {};
                this.roleBtns.map( v => {
                  //权限判断
                  if( v &&(o.value === v.code)){
                    obj = o;
                  }
                });
                if(obj.value){
                  fnsclick.push(obj)
                }
              });
              item.fnsclick = fnsclick;
            }
          })
        }
      },
    }
  };
</script>
<style rel="stylesheet/scss" lang="scss">
  @import '../../../assets/css/public';

  $baseH: 39px; //基础表头高度
  $baseLH: 32px; //基础表头行高
  .ns-grids {
    //表格主体部分
    .el-table {
      thead tr th:last-child {
        padding: 0;
        height: $baseH;
        max-height: $baseH;
        line-height: $baseH;
        box-sizing: border-box;
        .cell {
          height: 100%;
          line-height: $baseLH;
        }
      }
      .grid-head-headOperation {
        border-right: 0;
      }
    }
  }
</style>
